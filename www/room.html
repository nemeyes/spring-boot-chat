<!doctype html>
<html lang="en">
  <head>
    <title>씨어스테크</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
      [v-cloak] {
          display: none;
      }
    .chat-area {
        /*   border: 1px solid #ccc; */
        background: white;
        height: 80vh;
        padding: 0em;
        overflow: auto;
        max-width: 100%;
        margin: 0 auto 2em auto;
        /*box-shadow: 1px 1px 3px 1px rgba(0, 0, 0, 0.3)*/
    }
    .message {
        width: 40%;
        border-radius: 10px;
        padding: .5em;
        margin-bottom: .5em;
        font-size: .9em;
    }
    
    .message-out {
        background: #407FFF;
        color: white;
        margin-left: 59%;
        margin-top:5px;
    }
    
    .message-in {
        background: #F1F0F0;
        color: black;
        margin-left: 1%;
        margin-top:5px;
    }

    .message-out a {
        background: #407FFF;
        color: white;
        margin-top:5px;
    }

    .modal-mask {
        position: fixed;
        z-index: 9998;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, .5);
        display: table;
        transition: opacity .3s ease;
    }

    .modal-wrapper {
        display: table-cell;
        vertical-align: middle;
    }

    .modal-container {
        width: 800px;
        margin: 0px auto;
        padding: 20px 30px;
        background-color: #fff;
        border-radius: 2px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .33);
        transition: all .3s ease;
        font-family: Helvetica, Arial, sans-serif;
    }

    .modal-header h5 {
        margin-top: 0;
        color: #42b983;
    }

    .modal-body {
        margin: 20px 0;
    }

    .modal-default-button {
        float: right;
    }

    .modal-enter {
        opacity: 0;
    }

    .modal-leave-active {
        opacity: 0;
    }

    .modal-enter .modal-container,
    .modal-leave-active .modal-container {
        -webkit-transform: scale(1.1);
        transform: scale(1.1);
    }
    div > img {
        max-width: 100%;
        max-height: 100%;
    }
    </style>
  </head>
  <body>
    <div class="container" id="app" v-cloak>
        <div class="row">
            <div class="col-md-6">
                <h4>{{room_name}} <span class="badge badge-info badge-pill">{{user_count}}</span></h4>
            </div>
            <div class="col-md-6 text-right">
                <a class="btn btn-primary btn-sm" @click="logout">로그아웃</a>
                <a class="btn btn-info btn-sm" href="lobby.html">로비로 이동하기</a>
                <a class="btn btn-info btn-sm" @click="leave_room">방(Room) 탈퇴하기</a>
            </div>
        </div>
        <div class="input-group-lg">
            <div class="input-group-lg">
                <label class="input-group-text">{{room_description}}</label>
            </div>
        </div>
        <p>

        </p>
        <div class="row">
            <ul class="col-md-10">

                <section ref="chatArea" class="chat-area">
                    <li v-for="(message, index) in messages" class="message" :class="{ 'message-out': message.user_id === user_id, 'message-in': message.user_id !== user_id }">
                        <div v-if="message.user_id === user_id">
                            <input  type="radio" :value="message.id" v-model="message_id" @Click="set_message_index(index)"> {{message.nickname}} ({{message.timestamp}})
                        </div>
                        <div v-if="message.user_id !== user_id">
                            <input  type="checkbox" :value="message.id" v-model="message_ids" @Click="set_message_index(index)"> {{message.nickname}} ({{message.timestamp}})
                        </div>
                        <div v-if="message.has_parent">
                            <div v-if="!message.parent_has_file">
                                <u>{{ message.parent_message }} 글에 대한 댓글입니다.</u>
                            </div>
                            <div v-if="message.parent_has_file">
                                <img v-if="message.parent_is_image" :src="message.parent_download_path" width="50"/>
                                <a v-if="!message.parent_is_image" class="active" :href="message.parent_download_path">다운로드</a>
                                에 대한 댓글입니다.
                            </div>
                        </div>
                        <div v-if="!message.has_file">{{ message.message }}</div>
                        <div v-if="message.has_file">
                            <img v-if="message.is_image" :src="message.download_path"/>
                            <a v-if="!message.is_image" class="active" :href="message.download_path">다운로드</a>
                        </div>
                        <div v-if="message.unread" style="display: flex; justify-content: flex-end"><div>읽지않음</div></div>
                        <div v-if="message.unread_count>0" style="display: flex; justify-content: flex-end"><div>{{ message.unread_count }}</div></div>
                    </li>
                  </section>
            </ul> 
            <div class="col-md-2">
                <div class="input-group-lg">
                    <label class="input-group-text">방(Room) 참여자</label>
                </div>
                <li class="list-group-item list-group-item-action" v-for="item in users" v-if="item.user_joined_room" v-bind:key="item.user_id">
                    <h6>{{item.user_nickname}}</h6>
                </li>
                <div class="input-group-lg">
                    <a id="show-modal" class="input-group-text" @click="show_invite_user_modal = true">사용자 초대하기</a>
                </div>
                <modal v-if="show_invite_user_modal" @close="show_invite_user_modal = false">
                    <h5 slot="header">방(Room)에 초대할 사람을 추가하세요.</h5>
                    <div slot="body">
                        <div class="input-group-prepend">
                            <label class="input-group-text">사용자 아이디</label>
                            <input type="text" class="form-control" v-model="invite_user_id">
                        </div>
                    </div>
                    <div slot="footer">
                        <div class="input-group-lg">
                            <a class="btn btn-primary" type="button" @click="invite_user">추가하기</a>
                            <a class="btn btn-outline-danger" type="button" @click="show_invite_user_modal = false">닫기</a>
                        </div>
                    </div>
                  </modal>
            </div>
        </div>
        <div class="input-group">
            <div class="input-group-lg">
                <label class="input-group-text">메시지</label>
            </div>            
            <input type="text" class="form-control" v-model="message">
            <div class="input-group-lg">
                <a class="btn btn-primary" @click="send_message('MSG_TALK')">메시지</a>
                <a class="btn btn-info" @click="send_comment('MSG_TALK')">댓글</a>
                <a class="btn btn-outline-danger" @click="show_send_file_modal = true">파일</a>
                <a class="btn btn-outline-danger" @click="show_send_comment_file_modal = true">파일댓글</a>
                <a class="btn btn-outline-danger" @click="mark_as_read()">읽음</a>
                <a class="btn btn-outline-danger" @click="delete_message()">삭제</a>
                
            </div>
            <modal v-if="show_send_file_modal" @close="show_send_file_modal = false">
                <h5 slot="header">파일 전송</h5>
                <div slot="body">
                    <input type="file" @change="upload_file" ref="file"/>
                </div>
                <div slot="footer">
                    <div class="input-group-lg">
                        <a class="btn btn-primary" type="button" @click="submit_file">전송하기</a>
                        <a class="btn btn-outline-danger" type="button" @click="show_send_file_modal = false">닫기</a>
                    </div>
                </div>
            </modal>

            <modal v-if="show_send_comment_file_modal" @close="show_send_comment_file_modal = false">
                <h5 slot="header">댓글로 파일 전송</h5>
                <div slot="body">
                    <input type="file" @change="upload_file" ref="file"/>
                </div>
                <div slot="footer">
                    <div class="input-group-lg">
                        <a class="btn btn-primary" type="button" @click="submit_comment_file">전송하기</a>
                        <a class="btn btn-outline-danger" type="button" @click="show_send_comment_file_modal = false">닫기</a>
                    </div>
                </div>
            </modal>

        </div>
    </div>
    <!-- JavaScript -->
    <script src="/js/vue.min.js"></script>
    <script src="/js/axios.min.js"></script>
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>
    <script type="text/x-template" id="modal-template">
        <transition name="modal">
            <div class="modal-mask">
                <div class="modal-wrapper">
                    <div class="modal-container">
                        <div class="modal-header">
                            <slot name="header">
                                default header
                            </slot>
                        </div>
                        <div class="modal-body">
                            <slot name="body">
                                default body
                            </slot>
                        </div>
                        <div class="modal-footer">
                            <slot name="footer">
                              default footer
                              <button class="modal-default-button" @click="$emit('close')">
                                OK
                              </button>
                            </slot>
                          </div>  
                    </div>
                </div>
            </div>
        </transition>
    </script>
    <script>
        //var _this = null;
        //var host = 'http://localhost:3030';
        var host = 'https://chat-api.seers-visual-system.link';
        //var host = 'https://chat-api-dev.seers-visual-system.link';
        //var host = 'http://3.38.246.104';
        //var host = 'http://3.38.246.104:3030';
        var sock = new SockJS(host + "/seers");
        var ws = Stomp.over(sock);
        Vue.component('modal', {
            template: '#modal-template'
        });
        var vm = new Vue({
            el: '#app',           
            data: {
                gran_type : '',
                access_token : '',
                refresh_token : '',
                refresh_token_expiration_time : '',
                user_id : '',
                user_nickname : '',
                user_role : '',

                room_id: '',
                room_name: '',
                room_description: '',
                
                show_invite_user_modal: false,
                message: '',
                messages: [],
                access_token: '',
                user_count: 0,
                users : [],
                all_users: [],
                invite_user_id: '',
                user_nicknames : null,
                message_id: '',
                message_ids: [],
                message_index: -1,
                after_reissue_func: null,

                show_send_file_modal : false,
                show_send_comment_file_modal: false,

                files : null
            },
            created() {
                this.grant_type = localStorage.getItem('seerschat.grant_type');
                this.access_token = localStorage.getItem('seerschat.access_token');
                this.refresh_token = localStorage.getItem('seerschat.refresh_token');
				this.refresh_token_exp_time = localStorage.getItem('seerschat.refresh_token_expiration_time');
				this.user_id = localStorage.getItem('seerschat.user_id');
				this.user_nickname = localStorage.getItem('seerschat.user_nickname');
				this.user_role = localStorage.getItem('seerschat.user_role');

                if(this.access_token==null || this.access_token===undefined) {
                    location.href="login.html";
                }

                this.room_id = localStorage.getItem('seerschat.room_id');
                this.room_name = localStorage.getItem('seerschat.room_name');
                this.room_description = localStorage.getItem('seerschat.room_description');
                
                this.user_nicknames = new Map();

                var _this = this;

                this.get_room_users();

                ws.connect({ "Authorization" : _this.grant_type + ' ' + _this.access_token }, function(frame) {
                    ws.subscribe("/sub/chat/room/" + _this.room_id, function(message) {
                        var recv = JSON.parse(message.body);
                        _this.recv_message(recv);
                    });
                }, 
                function(error) {
                    alert("채팅서버로 부터 응답이 없습니다. 관리자에게 문의하세요.");
                    location.href="lobby.html";
                });
            },
            methods: {
                set_message_index(index) {
                    this.message_index = index;
                },
                upload_file() {
                    this.files = this.$refs.file.files[0];
                },
                submit_file() {
                    const formData = new FormData();
                    formData.append('file', this.files);
                    formData.append('room_id', this.room_id);
                    formData.append('user_id', this.user_id);
                    //const headers = { 'Content-Type': 'multipart/form-data' };
                    axios.post(host + "/chat/upload", formData, {
                        headers : {
                            'Content-Type': 'multipart/form-data',
                            'Access-Control-Allow-Origin': '*',
                            'Access-Control-Allow-Headers': '*',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(response => {
                        if(response.data.code=="CODE_SUCCESS") {
                            
                        } else {
                            alert(response.data.message);
                        }
                        this.show_send_file_modal = false;                        
                    })
                    .catch( 
                        response => {
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.submit_file;
                                this.reissue();
                            } else {
                                alert("파일업로드 과정에서 오류가 발생했습니다.");
                            }
                        } 
                    );                    
                },
                submit_comment_file() {

                    if(this.message_ids.length>1) {
                        alert("댓글로 파일전송시에는 메시지 하나만 선택해주세요."); 
                        return;
                    }

                    if(this.messages[this.message_index].type!="MSG_TALK" && 
                       this.messages[this.message_index].type!="MSG_FILE") {
                        alert("댓글은 메시지와 파일에 대해서만 가능합니다."); 
                        return;
                    }

                    if(this.message_ids.length<1) {
                        alert("댓글달 메시지를 선택해주세요."); 
                        return;
                    }
                    if(this.messages[this.message_index].user_id==this.user_id) {
                        alert("본인이 작성한 글에 댓글을 달수 없습니다."); 
                        return;
                    }


                    const formData = new FormData();
                    formData.append('file', this.files);
                    formData.append('room_id', this.room_id);
                    formData.append('user_id', this.user_id);
                    formData.append('parent_message_id', this.message_ids[0]);
                    //const headers = { 'Content-Type': 'multipart/form-data' };
                    axios.post(host + "/chat/upload/comment", formData, {
                        headers : {
                            'Content-Type': 'multipart/form-data',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(response => {
                        if(response.data.code=="CODE_SUCCESS") {
                            
                        } else {
                            alert(response.data.message);
                        }
                        this.show_send_comment_file_modal = false;                        
                    })
                    .catch( 
                        response => {
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.submit_comment_file;
                                this.reissue();
                            } else {
                                alert("파일업로드 과정에서 오류가 발생했습니다.");
                            }
                        } 
                    );                    
                },
                logout: function() {
                    var payload = {
                        "access_token" : this.access_token,
                        "refresh_token" : this.refresh_token
                    };

                    axios.post(host + '/user/logout', JSON.stringify(payload), {
                        headers : {
                            'Content-Type' : 'application/json;charset=utf-8',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(response => {
                        if(response.data.code=="CODE_SUCCESS") {
                            localStorage.clear();
                            location.href="login.html";
                        } else {
                            alert("로그아웃에 실패했습니다."); 
                        }
                    })
                    .catch( 
                        response => {
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.logout;
                                this.reissue();
                            } else {
                                alert("로그아웃과정에서 오류가 발생했습니다.");
                            }
                        } 
                    );
                },
                reissue: function() {
                    var payload = {
                        "access_token" : this.access_token,
                        "refresh_token" : this.refresh_token
                    };

                    axios.post(host + '/user/reissue', JSON.stringify(payload), {
                        headers : {
                            'Content-Type' : 'application/json;charset=utf-8',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(response => {
                        if(response.data.code=="CODE_SUCCESS") {
                            this.grant_type = response.data.grant_type;
                            this.access_token = response.data.access_token;
                            this.refresh_token = response.data.refresh_token;
                            this.refresh_token_exp_time = response.data.refresh_token_exiration_time;

                            localStorage.setItem('seerschat.grant_type', this.grant_type);
                            localStorage.setItem('seerschat.access_token', this.access_token);
                            localStorage.setItem('seerschat.refresh_token', this.refresh_token);
                            localStorage.setItem('seerschat.refresh_token_expiration_time', this.refresh_token_exp_time);

                            //this.get_rooms();
                            if(this.after_reissue_func!=null && this.after_reissue_func!==undefined) {
                                this.after_reissue_func();
                            }
                        } else {
                            alert("토큰 재발급 과정에서 실패했습니다."); 
                            localStorage.clear();
                            location.href="login.html";
                        }
                    })
                    .catch( 
                        response => {
                            alert("토큰 재발급 과정에서 오류가 발생했습니다.");
                        } 
                    );
                },                
                get_room_users: function() {
                    var payload = {
                        "room_id" : this.room_id
                    };
                    axios.post(host + '/chat/room/users', JSON.stringify(payload), {
                        headers : {
                            'Content-Type' : 'application/json;charset=utf-8',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(
                        response => {
                            if(response.data.code=="CODE_SUCCESS") {
                                this.users = response.data.room_users;
                                this.user_count = 0;

                                Array.from(this.users).forEach(function(element) {
                                    vm.user_nicknames[element.user_id] = element.user_nickname;
                                    if(element.user_joined_room) {
                                        vm.user_count++;
                                    }
                                });
                                this.messages = []
                                this.get_room_messages();
                            } else {
                                alert(response.data.message); 
                            }
                        }
                    )
                    .catch( 
                        response => { 
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.get_room_users;
                                this.reissue();
                            } else {
                                alert("방(Room) 참여자 정보를 가져오는 과정에서 오류가 발생했습니다."); 
                                this.room_name = '';
                                this.users = [];
                            }
                        } 
                    );
                },
                get_room_messages: function() {
                    var payload = {
                        "room_id" : this.room_id,
                        "page" : 1,
                        "page_size": 100
                    };
                    axios.post(host + '/chat/messages', JSON.stringify(payload), {
                        headers : {
                            'Content-Type' : 'application/json;charset=utf-8',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(
                        response => {
                            if(response.data.code=="CODE_SUCCESS") {
                                Array.from(response.data.message_list).forEach(function(element) {
                                    vm.parse_room_message(element);
                                });

                            } else {
                                alert(response.data.message); 
                            }
                        }
                    )
                    .catch( 
                        response => {
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.get_room_messages;
                                this.reissue();
                            } else {
                                alert("방(Room) 메시지 목록을 가져오는 과정에서 오류가 발생했습니다."); 
                            }
                        } 
                    );
                },
                leave_room: function() {
                   var payload = {
                        "room_id" : this.room_id
                    };
                    axios.post(host + '/chat/room/leave', JSON.stringify(payload), {
                        headers : {
                            'Content-Type' : 'application/json;charset=utf-8',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(
                        response => {
                            if(response.data.code=="CODE_SUCCESS") {
                                location.href="lobby.html";
                            } else {
                                alert(response.data.message); 
                            }
                        }
                    )
                    .catch( 
                        response => { 
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.leave_room;
                                this.reissue();
                            } else {
                                alert("방(Room)을 이탈하는 과정에서 오류가 발생했습니다."); 
                            }
                        } 
                    );
                },
                invite_user: function() {
                    if("" === this.invite_user_id) {
                        alert("초대할 사용자 아이디를 입력해주세요.");
                        return;
                    } else {
                        var payload = {
                            "room_id" : this.room_id,
                            "user_id" : this.invite_user_id
                        };
                        axios.post(host + '/chat/room/invite', JSON.stringify(payload), {
                            headers : {
                                'Content-Type' : 'application/json;charset=utf-8',
                                'Authorization' : this.grant_type + ' ' + this.access_token
                            }
                        })
                        .then(
                            response => {
                                if(response.data.code=="CODE_SUCCESS") {
                                    this.get_room_users();
                                } else {
                                    alert(response.data.message);
                                }
                                this.show_invite_user_modal = false;
                            }
                        )
                        .catch( 
                            response => { 
                                if(response.response.status==401) {
                                    alert("토큰이 만료되어 재발급 합니다.");
                                    this.after_reissue_func = this.invite_user;
                                    this.reissue();
                                } else {
                                    alert("사용자 초대과정에서 오류가 발생했습니다."); 
                                    this.show_invite_user_modal = false;
                                }
                            } 
                        );
                    }
                },              
                send_message: function(type) {
                    if(this.message==="") {
                        alert("메세지를 입력해주세요."); 
                        return;
                    }
                    ws.send("/pub/chat/message", {"Authorization":this.grant_type + ' ' + this.access_token}, JSON.stringify({type:type, room_id:this.room_id, message:this.message}));
                    this.message = '';
                },
                mark_as_read: function() {

                    if(this.message_ids.length<1) {
                        alert("읽음으로 표시할 메시지를 선택해주세요."); 
                        return;
                    }

                    if(this.messages[this.message_index].user_id==this.user_id) {
                        alert("본인이 작성한 글에 읽음표시를 할수 없습니다."); 
                        return;
                    }

                    var payload = {
                        "room_id" : this.room_id,
                        "message_ids" : this.message_ids
                    };
                    axios.post(host + '/chat/message/mread', JSON.stringify(payload), {
                        headers : {
                            'Content-Type' : 'application/json;charset=utf-8',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(
                        response => {
                            if(response.data.code=="CODE_SUCCESS") {
                            } else {
                                alert(response.data.message);
                            }
                        }
                    )
                    .catch( 
                        response => { 
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.mark_as_read;
                                this.reissue();
                            } else {
                                alert("읽음으로 처리과정에서 오류가 발생했습니다."); 
                            }
                        } 
                    );
                },
                send_comment: function(type) {
                    if(this.message==="") {
                        alert("메세지를 입력해주세요."); 
                        return;
                    }

                    if(this.message_ids.length>1) {
                        alert("댓글달 메시지는 하나만 선택해주세요."); 
                        return;
                    }

                    if(this.messages[this.message_index].type!="MSG_TALK" && 
                       this.messages[this.message_index].type!="MSG_FILE") {
                        alert("댓글은 메시지와 파일에 대해서만 가능합니다."); 
                        return;
                    }

                    if(this.message_ids.length<1) {
                        alert("댓글달 메시지를 선택해주세요."); 
                        return;
                    }
                    if(this.messages[this.message_index].user_id==this.user_id) {
                        alert("본인이 작성한 글에 댓글을 달수 없습니다."); 
                        return;
                    }

                    //alert(this.message_id);
                    ws.send("/pub/chat/message", {"Authorization":this.grant_type + ' ' + this.access_token}, JSON.stringify({type:type, room_id:this.room_id, message:this.message, parent_message_id:this.message_ids[0]}));
                    this.message = '';
                },              
                delete_message: function() {
                    if(this.message_id==="") {
                        alert("삭제할 메시지를 선택해주세요(라디오버튼 선택)."); 
                        return;
                    }
                    if(this.messages[this.message_index].user_id!=this.user_id) {
                        alert("본인이 작성한 글만 삭제가 가능합니다."); 
                        return;
                    }

                    var payload = {
                        "message_id" : this.message_id
                    };
                    axios.post(host + '/chat/message/delete', JSON.stringify(payload), {
                        headers : {
                            'Content-Type' : 'application/json;charset=utf-8',
                            'Authorization' : this.grant_type + ' ' + this.access_token
                        }
                    })
                    .then(
                        response => {
                            if(response.data.code=="CODE_SUCCESS") {
                            } else {
                                alert(response.data.message);
                            }
                        }
                    )
                    .catch( 
                        response => { 
                            if(response.response.status==401) {
                                alert("토큰이 만료되어 재발급 합니다.");
                                this.after_reissue_func = this.delete_message;
                                this.reissue();
                            } else {
                                alert("메시지 삭제 과정에서 오류가 발생했습니다."); 
                            }
                        } 
                    );
                },
                parse_room_message: function(recv) {
                    const has_parent = (recv.parent_message!=null && recv.parent_message!==undefined);
                    if(recv.type=="MSG_ENTER") {
                        if(recv.user_info !== undefined && recv.user_info != null) {
                           this.user_count = 0;
                           let found = false;
                           Array.from(this.users).forEach(function(element) {
                                    if(element.user_id==recv.user_info.user_id) {
                                        found = true;
                                        element.user_joined_room = true;
                                    }
                                });
                            if(found==false) {
                                this.users.push(recv.user_info);
                            }
                           Array.from(this.users).forEach(function(element) {
                                    if(element.user_joined_room) {
                                        vm.user_count++;
                                    }
                                });

                           this.user_nicknames[recv.user_info.user_id] = recv.user_info.user_nickname;
                        }

                        const nickname = this.user_nicknames[recv.user_id];
                        const message = nickname + "님이 참여하였습니다.";
                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message":message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                    } else if(recv.type=="MSG_QUIT") {
                        
                        if(recv.user_info !== undefined && recv.user_info != null) {
                           this.user_count = 0;
                           Array.from(this.users).forEach(function(element) {
                                    if(element.user_id==recv.user_info.user_id) {
                                        element.user_joined_room = false
                                    }

                                    if(element.user_joined_room) {
                                        vm.user_count++;
                                    }
                                });
                        }

                        const nickname = this.user_nicknames[recv.user_id];
                        const message = nickname + "님이 퇴장하였습니다.";
                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message":message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '',
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                    } else if(recv.type=="MSG_NOTI") {
                        const nickname = '';
                        const message = recv.message;
                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        if(recv.ntype=="NOTI_PLAIN_MESSAGE") {

                            this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message": "[알림] " + message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                        } else if(recv.ntype=="NOTI_START_SECTION") {

                            this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message": "[진료를 시작했습니다] " + message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                        } else if(recv.ntype=="NOTI_END_SECTION") {

                            this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message": "[진료를 종료했습니다] " + message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                        }
 
                    } else if(recv.type=="MSG_DELETE") {

                        const nickname = this.user_nicknames[recv.user_id];
                        const message = "삭제된 메시지 입니다";

                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        if(has_parent) {
                            if(recv.parent_message.type=="MSG_FILE") {

                                var parent_is_image = false;
                                if(recv.parent_message.file_mime_type==="image/gif" || 
                                   recv.parent_message.file_mime_type==="image/png" || 
                                   recv.parent_message.file_mime_type==="image/jpeg") {
                                    parent_is_image = true;
                                 }

                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": recv.parent_message.message, 
                                                    "parent_has_file": true,
                                                    "parent_is_image": parent_is_image,
                                                    "parent_download_path": recv.parent_message.file_download_path,
                                                    "has_file": false, 
                                                    "is_image": false, 
                                                    "download_path": '', 
                                                    "unread": false, 
                                                    "unread_count": 0});
                            } else {

                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": recv.parent_message.message, 
                                                    "parent_has_file": '',
                                                    "has_file": false, 
                                                    "is_image": false, 
                                                    "download_path": '', 
                                                    "unread": false, 
                                                    "unread_count": 0});
                            }
                        } else {
                            this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": false, 
                                                "parent_id": '',
                                                "parent_message": '', 
                                                "parent_has_file": false,
                                                "parent_is_image": false,
                                                "parent_download_path": '',
                                                "has_file": false, 
                                                "is_image": false, 
                                                "download_path": '', 
                                                "unread": false, 
                                                "unread_count": 0});
                        }
 
                    } else if(recv.type=="MSG_FILE") {

                        var is_image = false;
                        if(recv.file_mime_type==="image/gif" || recv.file_mime_type==="image/png" || recv.file_mime_type==="image/jpeg") {
                            is_image = true;
                        }
                        const nickname = this.user_nicknames[recv.user_id];
                        const message = recv.message;

                        var unreadMe = false;
                        var unreadCount = 0;
                        let unreadUserIds = recv.unread_user_id_list;
                        if(this.user_id==recv.user_id) {
                            unreadCount = unreadUserIds.length;
                        } else {
                            Array.from(unreadUserIds).forEach(function(element) {
                                if(vm.user_id==element) {
                                    unreadMe = true;
                                }
                            });
                        }

                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");

                        if(has_parent) {
                            if(recv.parent_message.type=="MSG_DELETE") {

                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": "삭제된 메시지",
                                                    "parent_has_file": false,
                                                    "parent_is_image": false,
                                                    "parent_download_path": '',
                                                    "has_file": false, 
                                                    "is_image": false, 
                                                    "download_path": '', 
                                                    "unread": unreadMe, 
                                                    "unread_count": unreadCount});

                            } else if(recv.parent_message.type=="MSG_FILE") {
                                var parent_is_image = false;
                                if(recv.parent_message.file_mime_type==="image/gif" || 
                                    recv.parent_message.file_mime_type==="image/png" || 
                                    recv.parent_message.file_mime_type==="image/jpeg") {
                                    parent_is_image = true;
                                }

                                this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": true, 
                                                "parent_id": recv.parent_message.message_id,
                                                "parent_message": '', 
                                                "parent_has_file": true,
                                                "parent_is_image": parent_is_image,
                                                "parent_download_path": recv.parent_message.file_download_path,
                                                "has_file": true, 
                                                "is_image": is_image, 
                                                "download_path": recv.file_download_path, 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});

                            } else {
                                this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": true, 
                                                "parent_id": recv.parent_message.message_id,
                                                "parent_message": recv.parent_message.message, 
                                                "parent_has_file": false,
                                                "parent_is_image": false,
                                                "parent_download_path": '',
                                                "has_file": true, 
                                                "is_image": is_image, 
                                                "download_path": recv.file_download_path, 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});

                            }

                        } else {
                            this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": false, 
                                                "parent_id": '',
                                                "parent_message": '', 
                                                "parent_has_file": false,
                                                "parent_is_image": false,
                                                "parent_download_path": '',
                                                "has_file": true, 
                                                "is_image": is_image, 
                                                "download_path": recv.file_download_path, 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});
                        }
                    } else {
                        const nickname = this.user_nicknames[recv.user_id];
                        const message = recv.message;

                        var unreadMe = false;
                        var unreadCount = 0;
                        let unreadUserIds = recv.unread_user_id_list;
                        if(this.user_id==recv.user_id) {
                            unreadCount = unreadUserIds.length;
                        } else {
                            Array.from(unreadUserIds).forEach(function(element) {
                                if(vm.user_id==element) {
                                    unreadMe = true;
                                }
                            });
                        }

                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        if(has_parent) {
                            if(recv.parent_message.type=="MSG_DELETE") {

                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": '"삭제된 메시지"',
                                                    "parent_has_file": false,
                                                    "parent_is_image": false,
                                                    "parent_download_path": '',
                                                    "has_file": false, 
                                                    "is_image": false, 
                                                    "download_path": '', 
                                                    "unread": unreadMe, 
                                                    "unread_count": unreadCount});

                            } else if(recv.parent_message.type=="MSG_FILE") {

                                var parent_is_image = false;
                                if(recv.parent_message.file_mime_type==="image/gif" || 
                                    recv.parent_message.file_mime_type==="image/png" || 
                                    recv.parent_message.file_mime_type==="image/jpeg") {
                                    parent_is_image = true;
                                }

                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": '',
                                                    "parent_has_file": true,
                                                    "parent_is_image": parent_is_image,
                                                    "parent_download_path": recv.parent_message.file_download_path,
                                                    "has_file": false, 
                                                    "is_image": false, 
                                                    "download_path": '', 
                                                    "unread": unreadMe, 
                                                    "unread_count": unreadCount});
                            
                            } else {
                            
                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": recv.parent_message.message, 
                                                    "parent_has_file": false,
                                                    "parent_is_image": false,
                                                    "parent_download_path": '',
                                                    "has_file": false, 
                                                    "is_image": false, 
                                                    "download_path": '', 
                                                    "unread": unreadMe, 
                                                    "unread_count": unreadCount});
                            
                            }
                        
                        } else {
                            
                            this.messages.push({"id": recv.message_id, 
                                                "type": recv.type, 
                                                "user_id": recv.user_id, 
                                                "nickname": nickname, 
                                                "message": message, 
                                                "timestamp": timestamp, 
                                                "has_parent": false, 
                                                "parent_id": '',
                                                "parent_message": '', 
                                                "parent_has_file": false,
                                                "parent_is_image": false,
                                                "parent_download_path": '',
                                                "has_file": false, 
                                                "is_image": false, 
                                                "download_path": '', 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});
                        
                        }
                        
                    }
                    Vue.nextTick(() => {
                        let messageDisplay = this.$refs.chatArea
                        messageDisplay.scrollTop = messageDisplay.scrollHeight
                    })
                },                      
                recv_message: function(recv) {
                    const has_parent = (recv.parent_message!=null && recv.parent_message!==undefined);
                    if(recv.type=="MSG_ENTER") {

                        if(recv.user_info !== undefined && recv.user_info != null) {
                           this.user_count = 0;
                           let found = false;
                           Array.from(this.users).forEach(function(element) {
                                    if(element.user_id==recv.user_info.user_id) {
                                        found = true;
                                        element.user_joined_room = false
                                    }
                                });
                            if(found==false) {
                                this.users.push(recv.user_info);
                            }

                           Array.from(this.users).forEach(function(element) {
                                    if(element.user_joined_room) {
                                        vm.user_count++;
                                    }
                                });

                           this.user_nicknames[recv.user_info.user_id] = recv.user_info.user_nickname;
                        }
                        const nickname = this.user_nicknames[recv.user_id];
                        const message = nickname + "님이 참여하였습니다.";
                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message":message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});
                    
                    } else if(recv.type=="MSG_QUIT") {

                        if(recv.user_info !== undefined && recv.user_info != null) {
                           this.user_count = 0;
                           Array.from(this.users).forEach(function(element) {
                                    if(element.user_id==recv.user_info.user_id) {
                                        element.user_joined_room = false
                                    }

                                    if(element.user_joined_room) {
                                        vm.user_count++;
                                    }
                                });
                        }

                        const nickname = this.user_nicknames[recv.user_id];
                        const message = nickname + "님이 퇴장하였습니다.";
                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message":message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});
                    
                    } else if(recv.type=="MSG_NOTI") {
                    
                        //const nickname = '';
                        //const message = recv.message;
                        //const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        const nickname = '';
                        const message = recv.message;
                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        if(recv.ntype=="NOTI_PLAIN_MESSAGE") {

                            this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message": "[알림] " + message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                        } else if(recv.ntype=="NOTI_START_SECTION") {

                            this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message": "[진료를 시작했습니다] " + message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                        } else if(recv.ntype=="NOTI_END_SECTION") {

                            this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message": "[진료를 종료했습니다] " + message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": false, 
                                            "is_image": false, 
                                            "download_path": '', 
                                            "unread": false, 
                                            "unread_count": 0});

                        }
                    
                    } else if(recv.type=="MSG_READ") {

                        this.messages.forEach(function(message, index) {
                            if(message.id==recv.message_id) {

                                var unreadMe = false;
                                var unreadCount = 0;
                                let unreadUserIds = recv.unread_user_id_list;
                                if(vm.user_id==recv.user_id) {
                                    unreadCount = unreadUserIds.length;
                                    vm.messages[index].unread_count = unreadCount;
                                } else {
                                    Array.from(unreadUserIds).forEach(function(element) {
                                        if(vm.user_id==element) {
                                            unreadMe = true;
                                        }
                                    });
                                    vm.messages[index].unread = unreadMe;
                                }
                                return;
                            }
                        });

                    } else if(recv.type=="MSG_DELETE") {

                        this.messages.forEach(function(message, index) {
                            if(message.id==recv.message_id) {
                                vm.messages[index].type = recv.type;
                                vm.messages[index].message = '"삭제된 메시지"';
                                vm.messages[index].has_file = false;
                                vm.messages[index].is_image = false;
                                vm.messages[index].download_path =  '';
                                vm.messages[index].unread = false;
                                vm.messages[index].unread_count = 0;
                                return;
                            }
                        });
                    } else if(recv.type=="MSG_PARENT_DELETE") {

                        this.messages.forEach(function(message, index) {
                            if(message.parent_id==recv.parent_message_id) {
                                vm.messages[index].parent_message = '"삭제된 메시지"';
                                vm.messages[index].parent_has_file = false;
                                vm.messages[index].parent_is_image = false;
                                vm.messages[index].parent_download_path = '';
                                vm.messages[index].unread = false;
                                vm.messages[index].unread_count = 0;
                            }
                        });

                    } else if(recv.type=="MSG_ROOM_DELETE") {
                        location.href = "lobby.html";
                    } else if(recv.type=="MSG_FILE") {
                        var is_image = false;
                        if(recv.file_mime_type==="image/gif" || recv.file_mime_type==="image/png" || recv.file_mime_type==="image/jpeg") {
                            is_image = true;
                        }
                        const nickname = this.user_nicknames[recv.user_id];
                        const message = recv.message;

                        var unreadMe = false;
                        var unreadCount = 0;
                        let unreadUserIds = recv.unread_user_id_list;
                        if(this.user_id==recv.user_id) {
                            unreadCount = unreadUserIds.length;
                        } else {
                            Array.from(unreadUserIds).forEach(function(element) {
                                if(vm.user_id==element) {
                                    unreadMe = true;
                                }
                            });
                        }

                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        
                        if(has_parent) {
                            if(recv.parent_message.type=="MSG_DELETE") {
                                
                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": '"삭제된 메시지"',
                                                    "parent_has_file": false,
                                                    "parent_is_image": false,
                                                    "parent_download_path": '',
                                                    "has_file": true, 
                                                    "is_image": is_image, 
                                                    "download_path": recv.file_download_path, 
                                                    "unread": unreadMe, 
                                                    "unread_count": unreadCount});

                            } else if(recv.parent_message.type=="MSG_FILE") {
                                var parent_is_image = false;
                                if(recv.parent_message.file_mime_type==="image/gif" || 
                                    recv.parent_message.file_mime_type==="image/png" || 
                                    recv.parent_message.file_mime_type==="image/jpeg") {
                                    parent_is_image = true;
                                }

                                this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": true, 
                                                "parent_id": recv.parent_message.message_id,
                                                "parent_message": '', 
                                                "parent_has_file": true,
                                                "parent_is_image": parent_is_image,
                                                "parent_download_path": recv.parent_message.file_download_path,
                                                "has_file": true, 
                                                "is_image": is_image, 
                                                "download_path": recv.file_download_path, 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});

                            } else {
                                this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": true, 
                                                "parent_id": recv.parent_message.message_id,
                                                "parent_message": recv.parent_message.message, 
                                                "parent_has_file": false,
                                                "parent_is_image": false,
                                                "parent_download_path": '',
                                                "has_file": true, 
                                                "is_image": is_image, 
                                                "download_path": recv.file_download_path, 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});

                            }
                        } else {

                            this.messages.push({"id": recv.message_id, 
                                            "type":recv.type, 
                                            "user_id":recv.user_id, 
                                            "nickname":nickname, 
                                            "message":message, 
                                            "timestamp":timestamp, 
                                            "has_parent": false,
                                            "parent_id": '', 
                                            "parent_message": '', 
                                            "parent_has_file": false,
                                            "parent_is_image": false,
                                            "parent_download_path": '',
                                            "has_file": true, 
                                            "is_image": is_image, 
                                            "download_path": recv.file_download_path, 
                                            "unread": unreadMe, 
                                            "unread_count": unreadCount});
                        }

                    } else {
                        const nickname = this.user_nicknames[recv.user_id];
                        const message = recv.message;

                        var unreadMe = false;
                        var unreadCount = 0;
                        let unreadUserIds = recv.unread_user_id_list;
                        if(this.user_id==recv.user_id) {
                            unreadCount = unreadUserIds.length;
                        } else {
                            Array.from(unreadUserIds).forEach(function(element) {
                                if(vm.user_id==element) {
                                    unreadMe = true;
                                }
                            });
                        }

                        const timestamp = new Date(recv.created_time).toLocaleDateString("euc-KR") + " " + new Date(recv.created_time).toLocaleTimeString("euc-KR");
                        if(has_parent) {

                            if(recv.parent_message.type=="MSG_DELETE") {
                                
                                this.messages.push({"id": recv.message_id, 
                                                    "type":recv.type, 
                                                    "user_id":recv.user_id, 
                                                    "nickname":nickname, 
                                                    "message":message, 
                                                    "timestamp":timestamp, 
                                                    "has_parent": true, 
                                                    "parent_id": recv.parent_message.message_id,
                                                    "parent_message": '"삭제된 메시지"',
                                                    "parent_has_file": false,
                                                    "parent_is_image": false,
                                                    "parent_download_path": '',
                                                    "has_file": false, 
                                                    "is_image": false, 
                                                    "download_path": '', 
                                                    "unread": unreadMe, 
                                                    "unread_count": unreadCount});

                            } else if(recv.parent_message.type=="MSG_FILE") {
                                var parent_is_image = false;
                                if(recv.parent_message.file_mime_type==="image/gif" || 
                                    recv.parent_message.file_mime_type==="image/png" || 
                                    recv.parent_message.file_mime_type==="image/jpeg") {
                                    parent_is_image = true;
                                }

                                this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": true, 
                                                "parent_id": recv.parent_message.message_id,
                                                "parent_message": '', 
                                                "parent_has_file": true,
                                                "parent_is_image": parent_is_image,
                                                "parent_download_path": recv.parent_message.file_download_path,
                                                "has_file": false, 
                                                "is_image": false, 
                                                "download_path": '', 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});

                            } else {
                                this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": true, 
                                                "parent_id": recv.parent_message.message_id,
                                                "parent_message": recv.parent_message.message, 
                                                "parent_has_file": false,
                                                "parent_is_image": false,
                                                "parent_download_path": '',
                                                "has_file": false, 
                                                "is_image": false, 
                                                "download_path": '', 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});

                            }
                            
                        } else {
                        
                            this.messages.push({"id": recv.message_id, 
                                                "type":recv.type, 
                                                "user_id":recv.user_id, 
                                                "nickname":nickname, 
                                                "message":message, 
                                                "timestamp":timestamp, 
                                                "has_parent": false,
                                                "parent_id": '', 
                                                "parent_message": '', 
                                                "parent_has_file": false,
                                                "parent_is_image": false,
                                                "parent_download_path": '',
                                                "has_file": false, 
                                                "is_image": false, 
                                                "download_path": '', 
                                                "unread": unreadMe, 
                                                "unread_count": unreadCount});
                        
                        }
                    }
                    Vue.nextTick(() => {
                        let messageDisplay = this.$refs.chatArea
                        messageDisplay.scrollTop = messageDisplay.scrollHeight
                    })
                }
            }
        });
    </script>
  </body>
</html>